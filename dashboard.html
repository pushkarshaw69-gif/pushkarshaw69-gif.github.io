<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>My Personal Space</h1>

<!-- JOURNAL -->
<h2>ğŸ““ Journal</h2>
<textarea id="journalText"></textarea>
<button onclick="saveJournal()">Save</button>
<div id="journalList"></div>

<hr>

<!-- QUOTES -->
<h2>âœï¸ Quotes</h2>
<input id="quoteInput">
<button onclick="saveQuote()">Save</button>
<div id="quotes"></div>

<hr>

<!-- IMAGES -->
<h2>ğŸ–¼ Images</h2>
<input type="file" id="imgFile">
<button onclick="uploadImage()">Upload</button>
<div id="imageGallery"></div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  onAuthStateChanged(auth, user => {
  if (!user) {
    window.location = "index.html";
  }
};
import {
  collection,
  addDoc,
  query,
  where,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const IMGBB_API = "5ff9c18ba71e0ffa14180a3d38bb59ce";

// AUTH CHECK
onAuthStateChanged(auth, user => {
  if (!user) window.location = "index.html";
  loadJournal();
  loadQuotes();
  loadImages();
});

// JOURNAL
window.saveJournal = async () => {
  await addDoc(collection(db, "journals"), {
    uid: auth.currentUser.uid,
    text: journalText.value,
    time: new Date()
  });
  journalText.value = "";
};

function loadJournal() {
  const q = query(collection(db, "journals"), where("uid", "==", auth.currentUser.uid));
  onSnapshot(q, snap => {
    journalList.innerHTML = "";
    snap.forEach(doc => {
      journalList.innerHTML += `<p>${doc.data().text}</p>`;
    });
  });
}

// QUOTES
window.saveQuote = async () => {
  await addDoc(collection(db, "quotes"), {
    uid: auth.currentUser.uid,
    text: quoteInput.value
  });
  quoteInput.value = "";
};

function loadQuotes() {
  const q = query(collection(db, "quotes"), where("uid", "==", auth.currentUser.uid));
  onSnapshot(q, snap => {
    quotes.innerHTML = "";
    snap.forEach(doc => {
      quotes.innerHTML += `<p>â€œ${doc.data().text}â€</p>`;
    });
  });
}

// IMAGES (ImgBB)
window.uploadImage = () => {
  const file = imgFile.files[0];
  if (!file) return alert("Select image");

  const formData = new FormData();
  formData.append("image", file);

  fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API}`, {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    addDoc(collection(db, "images"), {
      uid: auth.currentUser.uid,
      url: data.data.url
    });
  });
};

function loadImages() {
  const q = query(collection(db, "images"), where("uid", "==", auth.currentUser.uid));
  onSnapshot(q, snap => {
    imageGallery.innerHTML = "";
    snap.forEach(doc => {
      imageGallery.innerHTML += `<img src="${doc.data().url}">`;
    });
  });
}
</script>

</body>
</html>